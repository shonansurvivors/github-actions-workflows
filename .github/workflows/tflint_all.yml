name: tflint all dirs

on:
  workflow_call:
    inputs:
      tf_root_dir:
        required: false
        type: string
        default: .
      tflint_version:
        required: false
        type: string
        default: 0.34.1
      own_tflint_hcl_exists:
        required: false
        type: boolean
        default: false
      tflint_hcl_path:
        required: false
        type: string
        default: .tflint.hcl

jobs:
  tflint:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - uses: terraform-linters/setup-tflint@7cf6558386ea02736c0a5edd3031f39c2dfeb206 #v1.1.0
        with:
          tflint_version: v${{ inputs.TFLINT_VERSION }}

      - name: Download ready-made .tflint.hcl
        if: ${{ !inputs.own_tflint_hcl_exists }}
        run: |
          curl -O https://raw.githubusercontent.com/shonansurvivors/github-actions-workflows/main/.tflint.hcl

      - name: Run tflint
        run: |
          tflint --init --config=${{ github.workspace }}/${{ inputs.tflint_hcl_path }}
          dirs=$(find ${{ inputs.tf_root_dir }} -type f -name '*.tf' -exec dirname {} \; | grep -v '\.terraform' | uniq)
          for dir in $dirs; do
            cd ${{ github.workspace }}/$dir
            results+=$(tflint --force --config=${{ github.workspace }}/${{ inputs.tflint_hcl_path }})
          done
          if [ ${#results[@]} -eq 0 ]; then
            exit 0
          else
            echo "$results"
            exit 1
          fi
